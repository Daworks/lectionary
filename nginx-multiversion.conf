server {
    server_name lectionary.kmc.or.kr;

    # Default root (Main branch / 2025)
    root    /var/www2/kmc/lectionary.kmc.or.kr/dist;

    proxy_cookie_path / "/; secure; SameSite=None";
    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-XSS-Protection "1; mode=block";
    add_header X-Content-Type-Options "nosniff";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    index   index.html index.php;

    # 1. Main Branch (2025) - Root URL
    location / {
        try_files $uri $uri/ /index.html;
    }

    # 2. 2025 Year URL (Alias to the same main build)
    location /2025 {
        alias /var/www2/kmc/lectionary.kmc.or.kr/dist;
        try_files $uri $uri/ /2025/index.html;
    }

    # 3. Previous Years (Separate builds)
    # Ensure you have built these branches and placed them in the corresponding directories

    location /2023 {
        alias /var/www2/kmc/lectionary.kmc.or.kr/2023;
        try_files $uri $uri/ /2023/index.html;
    }

    location /2024 {
        alias /var/www2/kmc/lectionary.kmc.or.kr/2024;
        try_files $uri $uri/ /2024/index.html;
    }

    location /2026 {
        alias /var/www2/kmc/lectionary.kmc.or.kr/2026;
        try_files $uri $uri/ /2026/index.html;
    }

    # Static assets caching (applied to all locations)
    location ~ \.(woff|woff2|otf|ttf|eot|pdf)$ {
        expires     max;
        add_header Cache-Control "public";
    }

    location ~ \.(png|jpe?g|svg|bmp)$ {
       access_log   off;
       log_not_found    off;
       add_header Cache-Control "no-cache, no-store, must-revalidate, proxy-revalidate";
    }

    location ~ \.(css|js)$ {
        expires 0;
        add_header Cache-Control "no-store, no-cache, must-revalidate";
    }

    # PHP handling (if needed, though project seems static)
    location ~ \.php$ {
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_intercept_errors off;
        fastcgi_buffer_size 16k;
        fastcgi_buffers 4 16k;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass unix:/run/php/php8.4-fpm-kmc.sock;
        fastcgi_index index.php;
        include fastcgi_params;
    }

    location ~ /\.(?!well-known).* {
        deny all;
    }

    http2 on;
    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/lectionary.kmc.or.kr/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/lectionary.kmc.or.kr/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
}
